\documentclass[12pt]{article}
\usepackage{graphicx}
\usepackage{subfigure}
\usepackage{color}

\addtolength{\textwidth}{3cm}
\addtolength{\hoffset}{-1.5cm}
\addtolength{\textheight}{3.0cm}
\addtolength{\voffset}{-1.5cm}


%\usepackage{geometry} % see geometry.pdf on how to lay out the page. There's lots.
%\geometry{letterpaper} % or letter or a5paper or ... etc
% \geometry{landscape} % rotated page geometry

% See the ``Article customise'' template for come common customisations

\title{HPS DAQ Operations Manual v2.0}
\author{Per Hansson Adrian, Omar Moreno, Sergey Boiarinov\thanks{Contact person for document.}, Nathan Baltzell }
%\date{} % delete this line to display the current date

%%% BEGIN DOCUMENT
\begin{document}

\maketitle

\tableofcontents

\section{System Description}
The HPS experiment data acquisition (DAQ) handles the acquisition of data for the two sub-detectors: the SVT,  and the ECal. HPS employs two DAQ architectures: the SVT is readout with Advanced Telecom Communications Architecture (ATCA) hardware while the ECal use VXS based hardware. The trigger system receives input from the ECal, and distributes a trigger signal to all detector subsystems to read out a selected event. Figure~\ref{fig:daq} gives a schematic block diagram of the DAQ system.

For the ECal, every VXS crate contains a Readout Controller (ROC) that collects digitized information, processes it, and sends it on to the Event Builder (EB). The ROC is a single blade Intel-based CPU module running DAQ software under CentOS Linux OS. For the SVT ATCA system, a multi-ROC setup runs on embedded processors situated on the ATCA main board. The EB assembles information from the SVT and ECal ROCs into a single event which is passed to the Event Recorder (ER) that writes it to a RAID5-based data storage system. The DAQ network system is a Foundry router providing high-speed connections between the DAQ components and to the JLab computing facility. 

\newpage
\section{DAQ Control}
\label{sec:daq_control}

\subsection{Starting the DAQ from scratch}\label{sec:daqstart}

\begin{enumerate}
\item 
Log into \texttt{clondaq5} as \texttt{clasrun}.
%\item 
%If not sure, check that you can open a X window
%\begin{enumerate}
%\item 
%From the terminal clon03:0.1: type \texttt{xterm} and make sure xterminal is opened. If it is not, message "X11 connection rejected because of wrong authentication." will show up. If not continue:
%\item 
%Kill xwindow, start new one (you will be on \texttt{clon03}) and log into \texttt{clon10}.  Make sure \texttt{xterm} command can open xterminal.
%\end{enumerate}
\item 
To start all DAQ processes, open a terminal and run:\newline
\texttt{> hps\_start}\newline
\texttt{> roc\_xterms\_start}\newline
This opens up all windows needed on the current workspace. The workspace should look like Fig.~\ref{fig:coda}.
\end{enumerate}
%=======================
\begin{figure}[htbp]
\begin{center}
    \includegraphics[width=\textwidth]{coda_view.png}
\caption{CODA workspace.}
\label{fig:coda}
\end{center}
\vspace*{-5mm}
\end{figure}
%=======================

\subsection{Killing the DAQ}\label{sec:daqexit}
Log into \texttt{clondaq5} as \texttt{clasrun}, then execute the two commands:\newline
\texttt{> hps\_exit}\newline
\texttt{> roc\_xterms\_exit}\newline
This does not have to be done from the same terminal used for Section \ref{sec:daqstart}.  Do not proceed with DAQ operations until all the windows in Fig.~\ref{fig:coda} have disappeared.

\subsection{Start and stop a run}\label{sec:startstop}
\begin{enumerate}
\item
Beamline checklist
\begin{enumerate}
\item
Beam conditions are ready for running (see beam line manual for more details).
\end{enumerate}
\item
ECal Checklist
\begin{enumerate}
\item
All HV are on.
\item
ECal monitoring app is running.
\item
ECal FADC and DISC2 scaler displays are running.
\end{enumerate}
\item
SVT Checklist
\begin{enumerate}
\item
SVT position is appropriate for the run. {\bf Check with shift leader if not sure.}
\item 
SVT Flange boards (\texttt{SVT/Flange} GUI) and SVT Front end boards (\texttt{/SVT/FEB Main} GUI) are powered  with no alarms. 
\newline
{\bf IF ON:} check that currents are updating: if not, try to reboot the "iochvCaen" IOC.
\newline
{\bf IF OFF:} 
\begin{enumerate}
\item 
Restart the FEBs turning on in the order: 1) 'DIGI', 2) 'ANAP' and then 3) 'ANAN'; buttons are at the top of the \texttt{/SVT/FEB Main} GUI.
\item
Power all the flange channels from   \texttt{SVT/Flange}  GUI. 
\item 
Go to the \texttt{/SVT/Link Status} GUI and check that no FEB link errors are stably incrementing. If they do, try to cycle the flange board power (wait 10-20s between cycles). You may need up to 4 cycles.
\end{enumerate}
\item 
Bias high voltage is ON and at 180V (unless SVT expert has told you something different). 
\newline If the the HV is OFF and won't come on you might need to go and reset the interlock by going to the \texttt{Devices/SVT Soft Interlocks} GUI and Reseting the MPOD interlock. This happens after a beam trip. 
\newline {\bf \textcolor{red}{Important: Check that beam conditions for turning on bias voltage is OK before swiching on (see above)!}}

\item
SVT DAQ is in a state ready to run:
\begin{enumerate}
\item
Check that all the Control and Data DPMs and DTMs in \texttt{SVT/DAQ IOC Status} GUI are OK. 
\newline NOTE1: If there was a reboot of the SVT DAQ software or COB (see below) the data DPMs might not show green until after the 'Download' transition. 
\newline NOTE2:The control DPM should be OK as soon as a single FEB (and flanges are powered). It might take up to 30s for it to become green.

\item
Check that error counts in the \texttt{SVT/svtDpmLinkStatus} GUI are zero and not updating.

\item
In \texttt{/SVT/DPM Status} GUI": check that all data DPMs are in the appropriate CODA Run state e.g. if you are in 'Download' all should be in that state, etc. 
\newline NOTE: This may be not updated if there was a DAQ restart, e.g. the DPMs might be in 'End' as they doesn't know that CODA was restarted until 'Download' is initiated.
\end{enumerate}
\end{enumerate}

\item
{\bf If continuing with same the same run configuration from a stopped run continue to \ref{item:prestart}.}
\item
Go to the \texttt{RunControl} GUI: click \texttt{connect}, a new GUI window opens.
\item
Click on \texttt{DAQ Configuration}, choose 'HPS' and choose the configuration that has been explained to you: either on the run plan wiki or on the whiteboard. Click OK.
\item
Check that run number, data filename and run configuration filename shown on \texttt{RunControl} GUI are correct. The "download" button should appear. 
\item
\label{item:download}
Press \texttt{Download}. 
\begin{enumerate}
\item
Wait until the "Prestart" button appears and  \texttt{RunControl} GUI reports that Download was completed. This might takes up to 30s to complete. 
\item
Go to the \texttt{/SVT/svtDpmRunState} GUI and check that all DPM's are in "Download" state. \
\item
When \texttt{Prestart} button shows up the DAQ is ready to take data. 
\end{enumerate}
\item
\label{item:prestart}
Press \texttt{Prestart} and wait between 5 and 10s and no errors are reported. 
\begin{enumerate}
\item
Go to the \texttt{/SVT/svtDpmRunState} GUI and check that all DPM's are in "Prestart" state. 
\item
Go to the \texttt{/SVT/Hybrid Sync} GUI and check that all hybrids are in "sync" i.e. the \texttt{SyncDetected} variable should be \texttt{0x1f} and indicator should be \textcolor{green}{green} for all hybrids.
\end{enumerate}
\item
Press \texttt{Go} to start the run. 
\begin{enumerate}
\item
Check that the run status is 'running' and that triggers are issued. 
\item
Verify that the SVT DAQ started run properly:
\begin{enumerate}
\item
Go to the \texttt{svtDpmRunState} GUI and 
\begin{enumerate}
\item
Check that all DPM's are in "Go" state 
\item
Check that the \texttt{TrigCount} is incrementing for both DPM and DTMs and are similar.
\item
Check that the \texttt{EventCount} is incrementing.
\end{enumerate}
\end{enumerate}
\end{enumerate}
\end{enumerate}

\subsection{Stopping a run}
\begin{enumerate}
\item
Go to the \texttt{RunControl}  GUI and press \texttt{End Run} to stop data taking. 
\item
End of run SVT DAQ checklist:
\begin{enumerate}
\item
Go to the \texttt{/SVT/svtDpmRunState} GUI and:
\begin{enumerate}
\item
Check that the CODA run state is  \texttt{Stopped} for all DPMs and DTMs.
\item
Check that the \texttt{TrigCount} and \texttt{EventCount} variables for DPMs and DTMs are identical and the indicators are \textcolor{green}.
\end{enumerate}
\end{enumerate}
\end{enumerate}


\subsection{Beam trips: actions and recovery for DAQ}
Beam trips are frequent and in the most normal case the SVT high voltage bias will trip and will need to be restored before continuing.  If a beam trips happen:
\begin{enumerate}
\item Stop the run 
\item If the SVT is operating in a safe or fully retracted position follow these instructions. 

\textcolor{red}{If not, consult run coordinator for instructions on if the SVT position in these cases.}
\item When beam is back and we are ready go to the \texttt{softInterLocks} GUI under \texttt{Devices} on the HPS GUI. Reset the interlock for the SVT high voltage bias in the bottom right corner.
\item Go to the SVT high voltage GUI and ramp up voltages. 

\textcolor{red}{Make sure beam conditions and SVT positions are OK (see above) before ramping up high voltage}.

\item Go back to CODA \texttt{run\_control} and continue the run (see above).

\end{enumerate}


\newpage
\subsection{FIX DAQ}
All of this must be executed as user \texttt{clasrun} on machine \texttt{clondaq5}.
\subsubsection{Error During Download}
Try this if you get an error during download:
\begin{enumerate}
    \item In run control GUI: {\em Cancel}
    \item {\em Download} again
    \item If that still fails, repeat {\em Cancel} and {\em Download} once.
    \item If still fails, look at the run control GUI and try to determine which part of the system has a problem:
    \begin{enumerate}
    	\item If any of the 'dpm' or 'dtm' has problem this means the SVT DAQ is in a bad state: GOTO Section~\ref{fixsvtdaq}, else
    	\item GOTO Section \ref{fixdaqbig}.
    \end{enumerate}
    \item GOTO Step \#9 in Section \ref{sec:startstop}.
\end{enumerate}


\subsubsection{Full DAQ Teardown and ROC Reboots and Restart}\label{fixdaqbig}
If DAQ still doesn't work, try this before calling in the expert in the middle of the night.
\begin{enumerate}
    \item \texttt{hps\_exit}
    \item \texttt{roc\_xterms\_exit}
    \item Wait for all windows in Fig. \ref{fig:coda} to have disappeared.
    \item Ping all ROCs: 
        \subitem \texttt{ping hps11, hps12, hps1, hps2, hps1gtp, hps2gtp}
        \subitem If any fail or have times of $\sim\mu$s or more, reboot the culprit ROC (Section~\ref{sec:roc_reboot}) and {\em GOTO Step \#4 above}.
    \item Login to all ROCs (and logout afterwards): 
        \subitem\texttt{ssh hps11, hps12, hps1, hps2, hps1gtp, hps2gtp}
        \subitem If any fail to ssh successfully without error, reboot the culprit ROC (Section~\ref{sec:roc_reboot}) and {\em GOTO Step \#4 above}.
    \item If all 6 pings and all 6 sshs are succesful:
    \subitem \texttt{hps\_start}
    \subitem \texttt{roc\_xterms\_start}
\item GOTO Step \#5 in Section \ref{sec:startstop}
\end{enumerate}

\subsubsection{Rebooting a ROC}\label{sec:roc_reboot}
Execute this command (where \texttt{ROC} is one of \texttt{hps11, hps12, hps1, hps2}):\newline
\centerline{\texttt{roc\_reboot ROC}}

\vspace{5mm}\noindent
*Note that \texttt{hps1gtp} lives in \texttt{hps1}, so rebooting \texttt{hps1gtp} is done via \texttt{roc\_reboot hps1} (and similarly for \texttt{hps2gtp}).

\vspace{5mm}\noindent
{\em IF YOU REBOOT \texttt{hps11}, YOU MUST SUBSEQUENTLY REBOOT ALL OTHER ROCS \texttt{hps1, hps2, hps12} BEFORE PROCEEDING}.

\subsubsection{Restarting Individual CODA Commands}\label{sec:codacommands}
This is slightly more advanced.

If a CODA command dies (returns to prompt in the corresponding terminal) or a ROC must be rebooted, the CODA command for that ROC must be restarted.  The command can be manually executed again in the same terminal it was initally running in without a full DAQ restart.

If the ROC was not rebooted and only the CODA command died, the command should be the most recent in the shell history.  In this case you you should be able to press {\em up} in the terminal and re-execute the command.

Otherwise, here is a list of the CODA commands to be run on each ROC.  These should be executed in a terminal that is logged into the appropriate ROC (\texttt{hps1, hps2, hps11, hps12, hps1gtp,or hps2gtp}) as user \texttt{clasrun}.

\begin{itemize}
    \item{\texttt prxt\_linux\_ts.tcl hps11}
    \item{\texttt prxt\_linux\_gef.tcl hps1}
    \item{\texttt prxt\_linux\_gef.tcl hps2}
    \item{\texttt prxt\_linux\_gef.tcl hps12}
    \item{\texttt prxt\_linux.tcl hps1gtp}
    \item{\texttt prxt\_linux.tcl hps2gtp}
\end{itemize}


\subsubsection{FIX SVT DAQ}
\label{fixsvtdaq}

Before following the below procedure please record in a log entry what the status:
\begin{itemize}
\item What is the status of CODA: Did any of the ECAL ROCs crash? Did the EB, ET or ER crash? 
\item When did it fail: In state transition  'Download',  'Prestart'  or 'Go' or during a run?
\item What is the status of the ROCs (There are 15 DPMs and 2 DTMs): did they crash or report any error message?
\item Open the \texttt{/SVT/DAQ IOC Status} GUI and write down the status: which ones are red/green?
\item If this happened during Open the \texttt{/SVT/Hybrid Sync} GUI and write down if the status: which ones are red/green?

\end{itemize}

To try and resolve the SVT DAQ state try to follow these instructions.

\begin{enumerate}
    \item If one or many of the DPMs failed to or prestart
	\begin{enumerate}
    		\item Reboot the software by login into  \texttt{clondaq5} as 'clasrun'. \newline
		\texttt{> cd $\$$CLAS/slac\_svt/svtdaq/daq/rceScripts} \newline
		\texttt{> ./rem\_restart} \newline
		You will see the script connecting to each host. Wait until finished, can be up to 20s. \newline
		Wait until you can ping host 'dtm0' \newline
		Open the \texttt{/SVT/DAQ IOC Status} GUI and verify that the control DPMs are green; it may take up to 30s (the FEBs need to be powered).
		\item Go back to the run control GUI and repeat the 'Download' step (may need to 'Cancel' and 'Reset' first)
		\item If one or many DPMs are still having issues then reboot the "COB"  by login into  \texttt{clondaq5} as 'clasrun'. \newline
		\texttt{> cd $\$$CLAS/slac\_svt/svtdaq/daq/rceScripts} \newline
		\texttt{> ./reboot\_cob} \newline
		Wait at least 10s. \newline
		Make sure you can ping host 'dtm0' \newline
		Open the \texttt{/SVT/DAQ IOC Status} GUI and verify that the control DPMs are green; it may take up to 30s (the FEBs need to be powered). The data DPMs might be red until you go past to 'Download'.
		
 	\end{enumerate}
\end{enumerate}

    
   



%=======================
\begin{figure}[htbp]
\begin{center}
    \includegraphics[width=\textwidth]{daq.png}
\caption{Schematic overview of the DAQ and trigger system.}
\label{fig:daq}
\end{center}
%\vspace*{-5mm}
\end{figure}
%=======================


\end{document}
